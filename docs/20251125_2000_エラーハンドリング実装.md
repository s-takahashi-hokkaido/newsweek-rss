# エラーハンドリング実装

## 作成日時
2025-11-25 20:00

## 実装内容

### 1. カスタムエラーページ

#### 作成したファイル

| ファイル | 説明 | ステータスコード |
|---------|------|----------------|
| `resources/views/errors/404.blade.php` | ページが見つかりません | 404 |
| `resources/views/errors/500.blade.php` | サーバーエラー | 500 |
| `resources/views/errors/503.blade.php` | メンテナンス中 | 503 |

#### デザインコンセプト

**統一感**:
- 既存のレイアウト（`layouts/app.blade.php`）を継承
- Tailwind CSSで既存ページと同じスタイル
- ヘッダー・フッター完備で違和感なし

**視認性**:
- 大きなエラーコード（8xl）で状況を明確に表示
- 色分けでエラータイプを直感的に理解
  - 404: 赤色（警告）
  - 500: 赤色（エラー）
  - 503: 黄色（注意）
- アイコン付きで視覚的にわかりやすい

**ユーザビリティ**:
- 明確なアクションボタン
  - トップページへ戻る
  - 前のページへ戻る / ページを再読み込み
- 補足情報でユーザーの不安を軽減
- レスポンシブ対応（モバイルでも快適）

---

### 2. エラーハンドリングロジック

#### ファイル: `app/Exceptions/Handler.php`

**実装機能**:

1. **詳細なエラーログ記録**
   ```php
   - 404エラー: 通常ログ（URL、IP、User-Agent）
   - HTTPエラー: 詳細ログ（ステータスコード、ファイル、行番号）
   - 一般例外: 最詳細ログ（スタックトレース含む）
   ```

2. **開発環境と本番環境の切り替え**
   ```php
   - APP_DEBUG=true: デバッグ情報を画面表示
   - APP_DEBUG=false: ユーザーフレンドリーなエラーページ
   ```

3. **例外情報のビュー渡し**
   ```php
   - 500エラー時にexception変数をビューに渡す
   - 開発環境でのデバッグを容易に
   ```

---

### 3. エラーページの特徴

#### 404ページ（ページが見つかりません）

**メッセージ**:
- 「お探しのページは存在しないか、移動または削除された可能性があります」
- URLの確認を促す

**アクション**:
- トップページへ戻る
- 前のページへ戻る

**補足情報**:
- 記事は3ヶ月で自動削除されることを説明
- 検索ページへのリンク

---

#### 500ページ（サーバーエラー）

**メッセージ**:
- 「サーバーで問題が発生しました」
- 時間をおいて再試行を促す

**アクション**:
- トップページへ戻る
- ページを再読み込み

**開発環境での追加機能**:
```php
@if(config('app.debug') && isset($exception))
    // エラー詳細表示
    - Message
    - File
    - Line
@endif
```

**本番環境での補足**:
- キャッシュクリアを提案
- 別ブラウザを試すよう提案
- 管理者への問い合わせを促す

---

#### 503ページ（メンテナンス中）

**メッセージ**:
- 「システムメンテナンスを実施しております」
- ご不便をおかけすることへのお詫び

**アクション**:
- ページを再読み込み

**補足情報**:
- メンテナンス時間の目安（30分〜1時間）
- 時間をおいての再アクセスを促す

---

## エラーログの記録内容

### 404エラー（通常ログ）

```json
{
  "level": "info",
  "message": "404 Not Found",
  "context": {
    "url": "https://example.com/not-found",
    "method": "GET",
    "ip": "192.168.1.1",
    "user_agent": "Mozilla/5.0..."
  }
}
```

### 500エラー（詳細ログ）

```json
{
  "level": "error",
  "message": "Application Exception",
  "context": {
    "exception": "RuntimeException",
    "message": "Something went wrong",
    "url": "https://example.com/error",
    "method": "POST",
    "ip": "192.168.1.1",
    "user_agent": "Mozilla/5.0...",
    "file": "/var/www/newsweek-rss/app/Services/SomeService.php",
    "line": 42,
    "trace": "Stack trace..."
  }
}
```

---

## テスト方法

### 開発環境でのテスト

カスタムエラーページを確認するには、`APP_DEBUG=false`に設定する必要があります。

#### 1. デバッグモードをオフにする

```bash
# .env を編集
APP_DEBUG=false

# 設定をキャッシュ
php artisan config:cache
```

#### 2. テスト用URLにアクセス

開発環境では以下のテストURLが利用可能です：

```bash
# 404エラー
http://localhost/test-404

# 500エラー
http://localhost/test-500

# 503エラー
http://localhost/test-503
```

#### 3. 存在しないURLでテスト

```bash
http://localhost/non-existent-page
```

#### 4. テスト後はデバッグモードを戻す

```bash
# .env を編集
APP_DEBUG=true

# 設定をキャッシュ
php artisan config:cache
```

### 本番環境でのテスト

本番環境では`APP_DEBUG=false`が設定されているため、カスタムエラーページが自動的に表示されます。

---

## セキュリティ考慮事項

### 1. エラー情報の漏洩防止

**本番環境（APP_DEBUG=false）**:
- スタックトレースを表示しない
- ファイルパスを表示しない
- データベース情報を表示しない
- ユーザーフレンドリーなメッセージのみ

**開発環境（APP_DEBUG=true）**:
- 詳細なデバッグ情報を表示
- 開発を容易にする

### 2. ログへの記録

**機密情報の除外**:
```php
protected $dontFlash = [
    'current_password',
    'password',
    'password_confirmation',
];
```

パスワード関連の入力値はセッションにフラッシュされません。

### 3. XSS対策

Bladeテンプレートの`{{ }}`構文により、自動的にエスケープされます。

```blade
{{ $exception->getMessage() }} // 自動エスケープ
```

---

## 運用時の注意点

### 1. ログファイルのローテーション

エラーログは`storage/logs/laravel.log`に記録されます。

**推奨設定**:
```bash
# logrotateの設定例
/var/www/newsweek-rss/storage/logs/*.log {
    daily
    rotate 14
    compress
    missingok
    notifempty
    create 0644 www-data www-data
}
```

### 2. エラー監視

**推奨事項**:
1. 定期的にログファイルを確認
   ```bash
   tail -f storage/logs/laravel.log
   ```

2. 500エラーの発生頻度を監視
   ```bash
   grep "Application Exception" storage/logs/laravel.log | wc -l
   ```

3. 特定のエラーパターンを検出
   ```bash
   grep "ERROR" storage/logs/laravel.log
   ```

### 3. メンテナンスモード

計画的なメンテナンス時は、Laravelのメンテナンスモードを使用：

```bash
# メンテナンスモード開始
php artisan down --message="システムメンテナンス中" --retry=60

# メンテナンスモード終了
php artisan up
```

メンテナンスモード中は503ページが自動的に表示されます。

---

## 今後の改善案

### 短期

1. **エラー通知機能**
   ```php
   // 500エラー発生時にSlack/メール通知
   if ($e instanceof \Exception) {
       Notification::route('slack', env('SLACK_WEBHOOK'))
           ->notify(new ErrorOccurred($e));
   }
   ```

2. **エラー統計ダッシュボード**
   - 404エラーの多いURL
   - 500エラーの発生頻度
   - エラー発生時刻の分布

### 中期

1. **外部エラー監視サービスの導入**
   - Sentry
   - Bugsnag
   - Rollbar

2. **カスタム例外クラスの追加**
   ```php
   class ArticleNotFoundException extends Exception
   {
       // カスタムロジック
   }
   ```

### 長期

1. **多言語対応**
   - 英語版エラーページ
   - ユーザーの言語設定に応じた表示

2. **A/Bテスト**
   - エラーページのデザイン改善
   - ユーザー行動の分析

---

## まとめ

### 実装完了項目

- ✅ 404エラーページ（視認性良好、統一感あり）
- ✅ 500エラーページ（開発/本番環境の切り替え）
- ✅ 503エラーページ（メンテナンス対応）
- ✅ 詳細なエラーログ記録
- ✅ セキュリティ考慮（情報漏洩防止）
- ✅ レスポンシブデザイン
- ✅ テスト用ルート（開発環境のみ）

### デザイン評価

| 項目 | 評価 |
|------|------|
| 視認性 | ✅ 優秀 |
| 統一感 | ✅ 優秀 |
| ユーザビリティ | ✅ 優秀 |
| レスポンシブ | ✅ 対応済み |
| セキュリティ | ✅ 適切 |

### 要件達成

✅ **「ある程度の視認性を持たせる」** → 達成  
✅ **「通常ページと比べて違和感出ない」** → 達成

---

## 参考資料

- Laravel公式ドキュメント: [Error Handling](https://laravel.com/docs/errors)
- Tailwind CSS: [Color Palette](https://tailwindcss.com/docs/customizing-colors)
- 既存ページ: `resources/views/articles/index.blade.php`

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-11-25 | 初版作成（404/500/503エラーページ実装） |




