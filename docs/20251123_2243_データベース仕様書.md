# データベース仕様書

## 作成日時
2025-11-23 22:43

## 概要
ニューズウィーク日本版のRSS記事を保存・検索するためのデータベース設計

---

## RSS取得に関する重要事項

### RSS URL
```
https://www.newsweekjapan.jp/story/rss.xml
```

### 取得時の注意点

**User-Agentヘッダーが必須**

curlコマンドでRSSを取得する際、User-Agentヘッダーを指定しないとHTMLが返されます。

```bash
# ❌ 失敗例（HTMLが返される）
curl -s "https://www.newsweekjapan.jp/story/rss.xml"

# ✅ 成功例（XMLが返される）
curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
  "https://www.newsweekjapan.jp/story/rss.xml"
```

### RSSタグとデータベースカラムのマッピング

| データベースカラム | RSSタグ | 備考 |
|-------------------|---------|------|
| `title` | `<title>` | 記事タイトル |
| `url` | `<link>` | 記事URL（`<guid>`も同じ値） |
| `content` | `<description>` | 記事本文・要約 |
| `published_at` | `<pubDate>` | RFC 2822形式（例: `Mon, 10 Nov 2025 18:42:51 +0900`） |

**注意**: `<pubDate>`は保存前にDATETIME形式（`Y-m-d H:i:s`）に変換が必要

---

## テーブル設計

### 1. articles（記事テーブル）

#### 概要
RSSから取得した記事データを保存するメインテーブル

#### カラム定義

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | BIGINT UNSIGNED | NO | AUTO_INCREMENT | 主キー |
| url | VARCHAR(255) | NO | - | 記事URL（ユニーク）※実測最長66文字 |
| title | VARCHAR(255) | NO | - | 記事タイトル |
| content | TEXT | NO | - | 記事の内容 |
| published_at | DATETIME | NO | - | 記事公開日時 |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP ON UPDATE | レコード更新日時 |

#### インデックス設計

| インデックス名 | カラム | 種類 | 説明 |
|--------------|--------|------|------|
| PRIMARY | id | PRIMARY KEY | 主キー |
| idx_url | url | UNIQUE | URL完全一致検索・重複チェック用 |
| idx_published_at | published_at | INDEX | 日付範囲検索・ソート用（必須） |
| idx_title | title | FULLTEXT | タイトル部分一致検索用（100万件対応） |
| idx_created_at | created_at | INDEX | 古いデータ削除時の効率化 |

#### パフォーマンス対策

**100万件のデータでも高速検索を実現するための設計:**

1. **FULLTEXT INDEX（全文検索インデックス）**
   - タイトルの部分一致検索に`MATCH ... AGAINST`を使用
   - `LIKE '%keyword%'`よりも圧倒的に高速

2. **インデックスの役割分担**
   - `idx_published_at`: 日付範囲検索と結果のソート
   - `idx_url`: URL完全一致検索
   - `idx_title`: タイトル部分一致検索（FULLTEXT）

3. **ページネーション最適化**
   - `ORDER BY published_at DESC`は`idx_published_at`を活用
   - 大量データでは`OFFSET/LIMIT`より、カーソルベースページング推奨
   - 前ページの最後の日時を基準に次ページを取得する方式

#### 制約

- `url`: UNIQUE制約により重複記事の挿入を防止
- `published_at`, `title`, `content`: NOT NULL制約で必須データを保証

---

### 2. rss_fetch_logs（RSS取得ログテーブル）

#### 概要
RSSの最終取得日時と取得状況を記録するテーブル

#### カラム定義

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | BIGINT UNSIGNED | NO | AUTO_INCREMENT | 主キー |
| fetched_at | DATETIME | NO | - | RSS取得実行日時 |
| status | ENUM('success', 'failure') | NO | - | 取得成否 |
| articles_count | INT UNSIGNED | YES | NULL | 取得した記事数 |
| error_message | TEXT | YES | NULL | エラーメッセージ（失敗時） |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード作成日時 |

**注**: データ量が少ない（3ヶ月で約3万件）ため、追加インデックスは不要。主キーで`ORDER BY id DESC`すれば最新ログを高速取得可能。

#### 用途

1. **最終取得日時の表示**
   - 一覧画面で「最終更新: 2025-11-23 22:35」のように表示
   - ユーザーがデータの鮮度を確認可能

2. **取得履歴の管理**
   - 過去の取得成功/失敗履歴を保存
   - エラー発生時のデバッグに活用

3. **監視・アラート**
   - 連続して失敗している場合の検知
   - 5分以上取得がない場合の異常検知

#### データ保持期間

- 基本的に全履歴を保持
- 必要に応じて古いログ（例: 3ヶ月以上前）を削除するバッチを検討

---

## ER図（テキスト表現）

```
┌─────────────────────────────┐
│      articles               │
├─────────────────────────────┤
│ id (PK)                     │
│ url (UNIQUE)                │
│ title                       │
│ content                     │
│ published_at                │
│ created_at                  │
│ updated_at                  │
└─────────────────────────────┘

┌─────────────────────────────┐
│   rss_fetch_logs            │
├─────────────────────────────┤
│ id (PK)                     │
│ fetched_at                  │
│ status                      │
│ articles_count              │
│ error_message               │
│ created_at                  │
└─────────────────────────────┘

※ 2つのテーブル間にリレーションはなし（独立管理）
```

---

## データライフサイクル

### 記事データ（articles）

- **保存期間**: 3ヶ月
- **削除方法**: Artisanコマンドで定期削除
  - `created_at < NOW() - INTERVAL 3 MONTH` のレコードを削除
  - スケジューラーで毎日実行

### RSS取得ログ（rss_fetch_logs）

- **保存期間**: 3ヶ月
- **削除方法**: Artisanコマンドで定期削除
  - `created_at < NOW() - INTERVAL 3 MONTH` のレコードを削除
  - スケジューラーで毎日実行

---

## 備考

- UTF-8（utf8mb4）を使用し、絵文字対応
- タイムゾーンはAsia/Tokyoで統一
