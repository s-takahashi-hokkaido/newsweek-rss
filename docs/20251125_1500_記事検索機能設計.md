# 記事検索機能設計

## 作成日時
2025-11-25 15:00

## 概要
ニューズウィーク日本版の記事検索・一覧表示機能の実装設計書。
フェーズ2の中核機能として、ユーザーが記事を効率的に検索・閲覧できる機能を提供する。

---

## 設計方針の決定事項

### 1. 検索条件の保存方法

**決定**: Session

**理由**:
- サイズ制限の心配がない（Cookieは4KB制限）
- サーバー側で管理するためセキュア
- 検索条件は小さいデータなのでサーバー負荷は軽微
- セッション有効期限を長めに設定すれば利便性も確保可能

**実装詳細**:
- セッションキー: `article_search_conditions`
- 保存内容: `['date_from', 'date_to', 'url', 'title']`
- 検索実行時に自動保存、次回訪問時に自動復元

---

### 2. UIフレームワーク

**決定**: Tailwind CSS（CDN版）

**理由**:
- 現在のLaravelプロジェクトに既に埋め込まれている
- CDN版を使用することでビルドプロセス不要
- 導入手順書がシンプルになる（npm installが不要）
- モダンで柔軟性の高いデザインが可能

**CDN読み込み**:
```html
<script src="https://cdn.tailwindcss.com"></script>
```

---

### 3. ページネーション設定

**決定**: 20件/ページ

**理由**:
- ニュース記事として適切な表示件数
- パフォーマンスとUXのバランスが良い
- 100万件のデータでもページネーションで快適に閲覧可能

**設定ファイル**: `config/search.php` で外部化

---

### 4. 検索サービスの実装方針

**決定**: 案1（現状維持・シンプル実装）

**参考**: `docs/20251124_1359_検索パフォーマンス設計.md`

**理由**:
- Modelのscopeメソッドを活用したシンプルな実装
- ニュース記事のタイトル検索は固有名詞が多く、十分に絞り込まれる想定
- 保守性が高く、テストしやすい
- パフォーマンス問題が顕在化した場合に案2へ移行可能

**実装パターン**:
```php
$query = Article::query()
    ->byUrl($params['url'])
    ->byTitle($params['title'])
    ->publishedFrom($params['date_from'])
    ->publishedTo($params['date_to'])
    ->newest()
    ->paginate(20);
```

**将来的な改善案**:
- パフォーマンステスト実施後、必要に応じて検索戦略の分岐（案2）を実装
- スロークエリログで問題箇所を特定
- 検索エンジン（Meilisearch等）の導入は100万件超える場合に検討

---

## RSS取得状況の表示設計

### 目的
記事一覧画面で、現在表示されているデータが最新のRSS取得結果であるかを視覚的に明示する。
エラーが発生している場合は運用者が即座に気づけるようにする。

### 表示パターン

#### パターン1: 最新取得が成功 ✅

**表示内容**:
```
✓ 最終更新: 2025-11-25 14:30（正常に取得されました）
表示中のデータ: 2025-11-25 14:30 取得
```

**デザイン**:
- 背景色: 緑（`bg-green-50`）
- ボーダー: 緑（`border-green-200`）
- アイコン: チェックマーク
- トーン: 安心感を与える

**条件**:
- `rss_fetch_logs` の最新レコードの `status` が `'success'`

---

#### パターン2: 最新取得が失敗 ⚠️

**表示内容**:
```
⚠ 最終取得: 2025-11-25 14:30（取得に失敗しました）
エラー: [エラーメッセージ]
表示中のデータ: 2025-11-25 14:25 取得（前回成功時）
```

**デザイン**:
- 背景色: 赤（`bg-red-50`）
- ボーダー: 赤（`border-red-200`）
- アイコン: エラーマーク
- トーン: 警告、注意を促す

**条件**:
- `rss_fetch_logs` の最新レコードの `status` が `'failure'`

**表示内容**:
1. 最新取得の日時（失敗したもの）
2. エラーメッセージ（`error_message`）
3. 前回成功時の取得日時（表示中のデータの取得元）

---

#### パターン3: 取得履歴なし ℹ️

**表示内容**:
```
ℹ まだRSSが取得されていません
php artisan rss:fetch を実行してください
```

**デザイン**:
- 背景色: 灰色（`bg-gray-50`）
- ボーダー: 灰色（`border-gray-200`）
- アイコン: 情報マーク
- トーン: 中立的な情報提供

**条件**:
- `rss_fetch_logs` テーブルにレコードが存在しない

---

### コントローラーでの取得ロジック

```php
// app/Http/Controllers/ArticleController.php

use App\Models\RssFetchLog;

public function index(ArticleSearchRequest $request)
{
    // RSS取得状況を取得
    $latestFetch = RssFetchLog::latest()->first();
    $latestSuccess = RssFetchLog::latestSuccess();
    
    return view('articles.index', [
        'articles' => $articles,
        'latest_fetch' => $latestFetch,
        'latest_success' => $latestSuccess,
        'is_fetch_healthy' => $latestFetch && $latestFetch->isSuccess(),
    ]);
}
```

---

## 実装するファイル一覧

### 1. 設定ファイル

#### `config/search.php`（新規作成）
検索機能に関する設定を一元管理

```php
<?php

return [
    // ページネーション設定
    'per_page' => (int) env('SEARCH_PER_PAGE', 20),
    
    // 検索条件の保存先（session / cookie）
    'condition_storage' => env('SEARCH_CONDITION_STORAGE', 'session'),
    
    // セッションキー名
    'session_key' => 'article_search_conditions',
    
    // Cookieの有効期限（分）※将来的にCookieに変更する場合
    'cookie_lifetime' => (int) env('SEARCH_COOKIE_LIFETIME', 10080), // 7日間
];
```

---

### 2. バリデーション層

#### `app/Http/Requests/ArticleSearchRequest.php`（新規作成）
検索条件のバリデーションを担当

**バリデーションルール**:
- `date_from`: nullable, date_format:Y/m/d
- `date_to`: nullable, date_format:Y/m/d, after_or_equal:date_from
- `url`: nullable, url, max:255
- `title`: nullable, string, max:255

**責務**:
- 入力値のバリデーション
- エラーメッセージのカスタマイズ（日本語）

---

### 3. サービス層

#### `app/Services/ArticleSearchService.php`（新規作成）
検索ロジックとセッション管理を担当

**主要メソッド**:

1. `search(array $params): LengthAwarePaginator`
   - 検索条件を組み立て
   - Modelのscopeを使って検索実行
   - ページネーション結果を返却

2. `saveConditions(array $conditions): void`
   - 検索条件をセッションに保存

3. `loadConditions(): array`
   - セッションから検索条件を復元
   - 存在しない場合は空配列を返す

4. `clearConditions(): void`
   - セッションの検索条件をクリア

**実装例**:
```php
public function search(array $params): LengthAwarePaginator
{
    $query = Article::query()
        ->byUrl($params['url'] ?? null)
        ->byTitle($params['title'] ?? null)
        ->publishedFrom($params['date_from'] ?? null)
        ->publishedTo($params['date_to'] ?? null)
        ->newest();
    
    $perPage = config('search.per_page', 20);
    
    return $query->paginate($perPage);
}
```

---

### 4. コントローラー層

#### `app/Http/Controllers/ArticleController.php`（新規作成）
HTTPリクエストの受付とレスポンス返却（薄く保つ）

**ルートメソッド**:

1. `index(ArticleSearchRequest $request)`
   - 検索画面表示 + 検索実行
   - セッションから前回の検索条件を復元
   - RSS取得状況を取得してビューに渡す

**責務**:
- FormRequestでバリデーション
- ArticleSearchServiceに処理を委譲
- ビューにデータを渡す

---

### 5. ビュー層

#### `resources/views/layouts/app.blade.php`（新規作成）
共通レイアウト

**含む要素**:
- HTML基本構造
- Tailwind CSS CDN読み込み
- メタタグ（viewport, charset）
- `@yield('title')` - ページタイトル
- `@yield('content')` - メインコンテンツ

---

#### `resources/views/articles/index.blade.php`（新規作成）
記事検索・一覧画面

**構成要素**:

1. **RSS取得状況表示エリア**
   - 成功/失敗/未取得の3パターン
   - 条件分岐で色とメッセージを変更
   - SVGアイコンで視覚的に明示

2. **検索フォーム**
   - 日付範囲（yyyy/mm/dd 以降 / yyyy/mm/dd 以前）
   - URL（完全一致）
   - タイトル（部分一致）
   - 検索ボタン
   - クリアボタン（検索条件リセット）

3. **検索結果表示エリア**
   - ヒット件数（`{{ $articles->total() }}件`）
   - 記事一覧カード
     - 日付: `published_at`
     - URL: リンク（別タブで開く）
     - タイトル: 太字で強調
     - 内容: 最初の200文字程度を表示
   - ページネーション（`{{ $articles->links() }}`）

4. **結果なしメッセージ**
   - 検索条件に一致する記事がない場合

**デザイン方針**:
- レスポンシブ対応（モバイル・タブレット・PC）
- カード型レイアウト（見やすさ重視）
- 適切な余白とコントラスト
- アクセシビリティ考慮（カラーコントラスト、フォーカス表示）

---

### 6. ルーティング

#### `routes/web.php`（更新）

```php
use App\Http\Controllers\ArticleController;

Route::get('/', [ArticleController::class, 'index'])->name('articles.index');
```

**ルート設計**:
- トップページ（`/`）を記事検索画面とする
- GETメソッドで検索条件を受け取る（URLで共有可能）

---

### 7. テスト

#### `tests/Feature/Http/Controllers/ArticleControllerTest.php`（新規作成）
コントローラーの統合テスト

**テストケース**:
1. 検索画面の表示（200 OK）
2. URL検索でフィルタリング
3. タイトル検索でフィルタリング
4. 日付範囲検索でフィルタリング
5. 複合条件での検索
6. ページネーションの動作確認
7. 検索条件のセッション保存・復元
8. RSS取得状況の表示確認

---

#### `tests/Unit/Requests/ArticleSearchRequestTest.php`（新規作成）
FormRequestのバリデーションテスト

**テストケース**:
1. 正常な入力値（全項目）
2. 正常な入力値（項目なし・nullable）
3. 日付形式エラー（yyyy-mm-dd等）
4. date_to < date_fromエラー
5. URL形式エラー
6. 各項目の最大文字数超過

---

#### `tests/Unit/Services/ArticleSearchServiceTest.php`（新規作成）
サービス層のユニットテスト

**テストケース**:
1. URL検索の動作確認
2. タイトル検索の動作確認
3. 日付範囲検索の動作確認
4. 複合条件の動作確認
5. ページネーション件数の確認
6. セッション保存・読み込み・削除
7. 空の検索条件での全件取得

---

## データフロー

```
User Request (GET /)
    ↓
ArticleController@index
    ↓ FormRequest Validation
ArticleSearchRequest
    ↓ Load previous conditions from session
    ↓ Delegate to Service
ArticleSearchService@search
    ↓ Build query using Model Scopes
Article Model (with Scopes)
    ↓ Execute query with pagination
Database (MySQL)
    ↓ Return paginated results
ArticleController@index
    ↓ Get RSS fetch status
RssFetchLog Model
    ↓ Save search conditions to session
ArticleSearchService@saveConditions
    ↓ Render view
articles/index.blade.php
    ↓
User (View rendered HTML)
```

---

## セッション管理の詳細

### 検索条件の保存タイミング
- 検索ボタンクリック時
- 検索実行後、自動的にセッションに保存

### 検索条件の復元タイミング
- 画面初回表示時（検索パラメータがない場合）
- セッションに保存された値をフォームに自動入力

### セッションのクリア
- クリアボタンクリック時
- セッションとフォームの両方をクリア

### セッション構造
```php
session()->put('article_search_conditions', [
    'date_from' => '2025/11/01',
    'date_to' => '2025/11/30',
    'url' => 'https://example.com/article',
    'title' => 'Laravel',
]);
```

---

## パフォーマンス考慮事項

### インデックス利用
- URL検索: `idx_url` (UNIQUE INDEX) → 超高速
- 日付範囲: `idx_published_at` (INDEX) → 高速
- タイトル検索: `idx_title` (FULLTEXT) → 高速（キーワード次第）

### ページネーション
- `paginate(20)` により一度に取得するレコード数を制限
- `LIMIT 20 OFFSET N` のクエリが発行される
- 100万件のデータでも快適に閲覧可能

### N+1問題
- 現在の要件では記事単体のデータのみ表示
- リレーションがないためN+1問題は発生しない

### 参考ドキュメント
- `docs/20251124_1359_検索パフォーマンス設計.md`

---

## セキュリティ対策

### XSS対策
- Bladeの `{{ }}` による自動エスケープ
- ユーザー入力は必ずエスケープして出力

### SQLインジェクション対策
- Eloquent ORMによるプレースホルダー自動使用
- `whereRaw()` 使用時もバインディングパラメータを利用

### CSRF対策
- Laravel標準のCSRFトークン
- フォームに `@csrf` ディレクティブを追加

### バリデーション
- FormRequestで全ての入力を検証
- 型、形式、範囲を厳密にチェック

---

## エラーハンドリング

### バリデーションエラー
- FormRequestが自動的にリダイレクト
- エラーメッセージをフォーム上に表示
- 入力値は保持される（old()ヘルパー）

### データベースエラー
- QueryExceptionをキャッチ
- ユーザーフレンドリーなメッセージを表示
- 詳細エラーはログに記録

### RSS取得エラー
- 失敗時も記事一覧は表示（前回成功時のデータ）
- 警告メッセージで運用者に通知
- エラー内容を画面に表示

---

## 実装の推奨順序

### ステップ1: 設定とバリデーション
1. `config/search.php` 作成
2. `ArticleSearchRequest` 作成
3. テスト: `ArticleSearchRequestTest`

### ステップ2: サービス層
4. `ArticleSearchService` 作成
5. テスト: `ArticleSearchServiceTest`

### ステップ3: コントローラーとビュー
6. `ArticleController` 作成
7. `layouts/app.blade.php` 作成
8. `articles/index.blade.php` 作成
9. `routes/web.php` 更新

### ステップ4: 統合テストと動作確認
10. テスト: `ArticleControllerTest`
11. 全テスト実行: `php artisan test`
12. ブラウザで動作確認

---

## 将来的な拡張案

### 優先度: 低（オプション）

1. **検索条件のURL共有**
   - 検索条件をクエリパラメータに含める
   - URLをコピーして他の人と共有可能

2. **エクスポート機能**
   - 検索結果をCSV/Excelでダウンロード
   - 大量データの分析に活用

3. **お気に入り機能**
   - よく使う検索条件を保存
   - ワンクリックで呼び出し

4. **高度な検索**
   - 複数キーワード（AND/OR）
   - 除外キーワード（NOT）
   - 正規表現検索

5. **検索履歴**
   - 過去の検索条件を履歴として保存
   - 履歴から再検索

---

## 参考ドキュメント

- `REQUIREMENTS.md` - 課題要件
- `CLAUDE.md` - 実装ルール
- `docs/20251123_2243_データベース仕様書.md` - DB設計
- `docs/20251124_1359_検索パフォーマンス設計.md` - 検索最適化
- `docs/20251124_1400_今後の実装タスク一覧.md` - タスク管理
- `docs/20251125_0100_RSS取得機能設計.md` - RSS取得機能

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-11-25 | 初版作成（検索機能実装前の設計確定） |

