# データライフサイクル管理設計

## 作成日時
2025-11-25 15:30

## 目的

要件「保存期間は3か月」を実現するため、古いデータを自動削除する機能を実装する。

---

## 1. 要件整理

### 対象データ
- **articlesテーブル**: RSS取得した記事データ
- **rss_fetch_logsテーブル**: RSS取得履歴ログ

### 保存期間の定義
- **期間**: 90日固定（3ヶ月 = 90日）
- **基準日**: `created_at`（DB保存日時）
- **削除対象**: `created_at < NOW() - INTERVAL 90 DAY`

### `created_at` を基準とする理由
```
例：2024年8月1日公開の記事を、2024年10月30日に初めて取得

published_at 基準だと：
  - 取得時点で既に90日経過
  - 翌日の削除処理で即削除される
  - 「保存期間3ヶ月」の要件を満たせない ❌

created_at 基準だと：
  - 2024年10月30日に保存
  - 2025年1月30日まで保管
  - 正しく3ヶ月保管される ✅
```

---

## 2. 削除方式の設計

### 2.1 物理削除 vs ソフトデリート

**採用: 物理削除**

| 方式 | メリット | デメリット |
|------|---------|-----------|
| 物理削除 | ・ディスク容量節約<br>・シンプル<br>・パフォーマンス良好 | ・復元不可<br>・監査証跡なし |
| ソフトデリート | ・復元可能<br>・監査対応可 | ・容量増加<br>・複雑化 |

**判断理由**:
- テーブル設計で `deleted_at` カラムなし
- RSSから再取得可能
- 復元の要件なし
- ディスク容量を効率的に使用

### 2.2 削除処理方式

**採用: チャンク削除**

```php
// 一括DELETE（不採用）
Article::where('created_at', '<', now()->subDays(90))->delete();
// → ロック時間が長い、大量データで問題

// チャンク削除（採用）
Article::where('created_at', '<', now()->subDays(90))
    ->chunkById(1000, function ($articles) {
        $ids = $articles->pluck('id')->toArray();
        Article::whereIn('id', $ids)->delete();
    });
// → 1000件ずつ削除、ロック時間短縮
```

**チャンクサイズ: 1000件**
- 小さすぎる（100件）: 処理回数増加、オーバーヘッド大
- 大きすぎる（10000件）: ロック時間増加
- 1000件: バランス良好

---

## 3. 実行タイミング

### 3.1 スケジュール設定

```php
// app/Console/Kernel.php
protected function schedule(Schedule $schedule): void
{
    // 毎日午前3時に古い記事を削除
    $schedule->command('articles:cleanup')
        ->dailyAt('03:00')
        ->withoutOverlapping()
        ->appendOutputTo(storage_path('logs/cleanup.log'));
    
    // 毎日午前3時10分に古いログを削除（記事削除後）
    $schedule->command('logs:cleanup')
        ->dailyAt('03:10')
        ->withoutOverlapping()
        ->appendOutputTo(storage_path('logs/cleanup.log'));
}
```

### 3.2 実行時刻の選定理由

**午前3時を選択**:
- ✅ アクセスが少ない時間帯
- ✅ サーバー負荷が低い
- ✅ テーブルロックの影響最小化
- ✅ 検索機能への影響を許容

**毎日実行する理由**:
- 90日前のデータは毎日発生する
- 定期的な削除でディスク容量を安定化
- 週1回だと削除件数が増えロック時間が長くなる

### 3.3 多重実行防止

```php
->withoutOverlapping()
```

- 前回の削除処理が長引いた場合、次回実行をスキップ
- データ整合性の保護

---

## 4. 削除順序

### 4.1 テーブル間の依存関係

```
articles ← (参照なし) ← rss_fetch_logs
```

- 外部キー制約: なし
- リレーション: なし

### 4.2 削除順序

**1. articles → 2. rss_fetch_logs**

```bash
# 午前3時00分
php artisan articles:cleanup

# 午前3時10分（10分後）
php artisan logs:cleanup
```

**理由**:
- 外部キー制約がないため順序は自由
- メインデータ（articles）を先に削除
- ログ（rss_fetch_logs）は後から削除
- 10分間隔で実行を分散

---

## 5. 設定の外部化

### 5.1 設定ファイル

**新規作成: `config/data_lifecycle.php`**

```php
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | 記事データのライフサイクル設定
    |--------------------------------------------------------------------------
    */
    'articles' => [
        // 保存期間（日数）
        'retention_days' => env('ARTICLE_RETENTION_DAYS', 90),
        
        // チャンク削除のサイズ
        'chunk_size' => 1000,
        
        // 安全上限（この件数を超える場合は警告）※オプション機能
        'max_deletions_per_run' => 100000,
    ],

    /*
    |--------------------------------------------------------------------------
    | RSS取得ログのライフサイクル設定
    |--------------------------------------------------------------------------
    */
    'logs' => [
        // 保存期間（日数）
        'retention_days' => env('LOG_RETENTION_DAYS', 90),
        
        // チャンク削除のサイズ
        'chunk_size' => 1000,
    ],
];
```

### 5.2 環境変数（.env）

```env
# データライフサイクル設定
ARTICLE_RETENTION_DAYS=90
LOG_RETENTION_DAYS=90
```

### 5.3 .env.example に追加

```env
# データライフサイクル設定
ARTICLE_RETENTION_DAYS=90
LOG_RETENTION_DAYS=90
```

---

## 6. コマンド設計

### 6.1 記事削除コマンド

**ファイル: `app/Console/Commands/CleanupOldArticlesCommand.php`**

```php
<?php

namespace App\Console\Commands;

use App\Models\Article;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Log;

class CleanupOldArticlesCommand extends Command
{
    protected $signature = 'articles:cleanup
                          {--dry-run : 削除対象を表示するのみ（実際には削除しない）}';

    protected $description = '保存期間を過ぎた古い記事を削除';

    public function handle(): int
    {
        $retentionDays = config('data_lifecycle.articles.retention_days');
        $chunkSize = config('data_lifecycle.articles.chunk_size');
        $cutoffDate = now()->subDays($retentionDays);

        $this->info("削除対象: {$cutoffDate->format('Y-m-d H:i:s')} より古い記事");

        // 削除対象件数を取得
        $targetCount = Article::where('created_at', '<', $cutoffDate)->count();

        if ($targetCount === 0) {
            $this->info('削除対象の記事はありません');
            Log::info('記事削除: 対象なし');
            return self::SUCCESS;
        }

        $this->info("削除対象: {$targetCount}件");

        // Dry-runモード
        if ($this->option('dry-run')) {
            $this->warn('[Dry-run] 実際には削除しません');
            return self::SUCCESS;
        }

        // チャンク削除実行
        $deletedCount = 0;
        
        Article::where('created_at', '<', $cutoffDate)
            ->chunkById($chunkSize, function ($articles) use (&$deletedCount) {
                $ids = $articles->pluck('id')->toArray();
                $deleted = Article::whereIn('id', $ids)->delete();
                $deletedCount += $deleted;
                
                $this->info("削除中... ({$deletedCount}件)");
            });

        $this->info("削除完了: {$deletedCount}件");
        Log::info("記事削除完了", [
            'deleted_count' => $deletedCount,
            'cutoff_date' => $cutoffDate->toDateTimeString(),
        ]);

        return self::SUCCESS;
    }
}
```

### 6.2 ログ削除コマンド

**ファイル: `app/Console/Commands/CleanupOldLogsCommand.php`**

```php
<?php

namespace App\Console\Commands;

use App\Models\RssFetchLog;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Log;

class CleanupOldLogsCommand extends Command
{
    protected $signature = 'logs:cleanup
                          {--dry-run : 削除対象を表示するのみ（実際には削除しない）}';

    protected $description = '保存期間を過ぎた古いRSS取得ログを削除';

    public function handle(): int
    {
        $retentionDays = config('data_lifecycle.logs.retention_days');
        $chunkSize = config('data_lifecycle.logs.chunk_size');
        $cutoffDate = now()->subDays($retentionDays);

        $this->info("削除対象: {$cutoffDate->format('Y-m-d H:i:s')} より古いログ");

        // 削除対象件数を取得
        $targetCount = RssFetchLog::where('created_at', '<', $cutoffDate)->count();

        if ($targetCount === 0) {
            $this->info('削除対象のログはありません');
            Log::info('ログ削除: 対象なし');
            return self::SUCCESS;
        }

        $this->info("削除対象: {$targetCount}件");

        // Dry-runモード
        if ($this->option('dry-run')) {
            $this->warn('[Dry-run] 実際には削除しません');
            return self::SUCCESS;
        }

        // チャンク削除実行
        $deletedCount = 0;
        
        RssFetchLog::where('created_at', '<', $cutoffDate)
            ->chunkById($chunkSize, function ($logs) use (&$deletedCount) {
                $ids = $logs->pluck('id')->toArray();
                $deleted = RssFetchLog::whereIn('id', $ids)->delete();
                $deletedCount += $deleted;
                
                $this->info("削除中... ({$deletedCount}件)");
            });

        $this->info("削除完了: {$deletedCount}件");
        Log::info("ログ削除完了", [
            'deleted_count' => $deletedCount,
            'cutoff_date' => $cutoffDate->toDateTimeString(),
        ]);

        return self::SUCCESS;
    }
}
```

---

## 7. コマンドの使い方

### 7.1 手動実行

```bash
# 記事削除（本番実行）
php artisan articles:cleanup

# ログ削除（本番実行）
php artisan logs:cleanup

# Dry-run（削除対象だけ表示）
php artisan articles:cleanup --dry-run
php artisan logs:cleanup --dry-run
```

### 7.2 実行例

```bash
$ php artisan articles:cleanup --dry-run
削除対象: 2024-08-27 15:30:00 より古い記事
削除対象: 1,234件
[Dry-run] 実際には削除しません

$ php artisan articles:cleanup
削除対象: 2024-08-27 15:30:00 より古い記事
削除対象: 1,234件
削除中... (1000件)
削除中... (1234件)
削除完了: 1,234件
```

---

## 8. ログ出力

### 8.1 コンソール出力

```
削除対象: 2024-08-27 15:30:00 より古い記事
削除対象: 1,234件
削除中... (1000件)
削除中... (1234件)
削除完了: 1,234件
```

### 8.2 Laravelログ（storage/logs/laravel.log）

```
[2025-11-25 03:00:15] local.INFO: 記事削除完了 {"deleted_count":1234,"cutoff_date":"2024-08-27 15:30:00"}
```

### 8.3 スケジューラーログ（storage/logs/cleanup.log）

```bash
tail -f storage/logs/cleanup.log
```

---

## 9. パフォーマンス考慮事項

### 9.1 テーブルロック

**影響範囲**:
- チャンク削除により1000件ずつ処理
- 各チャンクのロック時間: 数ミリ秒〜数秒程度
- 午前3時実行のためユーザー影響は最小

**検索機能への影響**:
- 削除中は該当行がロックされる
- ただし午前3時はアクセスが少ないため許容範囲

### 9.2 インデックスの再構築

**結論: 不要**

- MySQLは DELETE 後に自動的にインデックスを更新
- 手動での OPTIMIZE TABLE は不要
- ただし年1回程度のメンテナンスでは有効

```sql
-- 必要に応じて実行（年1回程度）
OPTIMIZE TABLE articles;
OPTIMIZE TABLE rss_fetch_logs;
```

### 9.3 削除処理時間の見積もり

| データ件数 | 削除時間（概算） |
|-----------|----------------|
| 1,000件 | 1秒 |
| 10,000件 | 10秒 |
| 100,000件 | 1分40秒 |
| 1,000,000件 | 16分40秒 |

※ サーバースペックにより変動

---

## 10. テスト設計

### 10.1 テストファイル

**作成するテスト**:
- `tests/Feature/Console/Commands/CleanupOldArticlesCommandTest.php`
- `tests/Feature/Console/Commands/CleanupOldLogsCommandTest.php`

### 10.2 テストケース

#### 記事削除コマンドのテスト

```php
class CleanupOldArticlesCommandTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function 90日より古い記事が削除される()
    {
        // 91日前の記事（削除される）
        Article::factory()->create([
            'created_at' => now()->subDays(91),
        ]);

        // 90日前の記事（削除される）
        Article::factory()->create([
            'created_at' => now()->subDays(90)->subSecond(),
        ]);

        // 89日前の記事（残る）
        Article::factory()->create([
            'created_at' => now()->subDays(89),
        ]);

        $this->artisan('articles:cleanup')
            ->expectsOutput('削除完了: 2件')
            ->assertExitCode(0);

        $this->assertDatabaseCount('articles', 1);
    }

    /** @test */
    public function 削除対象がない場合はメッセージを表示()
    {
        Article::factory()->create([
            'created_at' => now()->subDays(30),
        ]);

        $this->artisan('articles:cleanup')
            ->expectsOutput('削除対象の記事はありません')
            ->assertExitCode(0);

        $this->assertDatabaseCount('articles', 1);
    }

    /** @test */
    public function dry_runオプションでは実際に削除されない()
    {
        Article::factory()->create([
            'created_at' => now()->subDays(91),
        ]);

        $this->artisan('articles:cleanup --dry-run')
            ->expectsOutput('削除対象: 1件')
            ->expectsOutput('[Dry-run] 実際には削除しません')
            ->assertExitCode(0);

        $this->assertDatabaseCount('articles', 1);
    }

    /** @test */
    public function 大量データのチャンク削除が正常に動作()
    {
        // 2500件の古い記事を作成
        Article::factory()->count(2500)->create([
            'created_at' => now()->subDays(91),
        ]);

        // 500件の新しい記事を作成
        Article::factory()->count(500)->create([
            'created_at' => now()->subDays(30),
        ]);

        $this->artisan('articles:cleanup')
            ->assertExitCode(0);

        $this->assertDatabaseCount('articles', 500);
    }
}
```

#### ログ削除コマンドのテスト

```php
class CleanupOldLogsCommandTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function 90日より古いログが削除される()
    {
        // 91日前のログ（削除される）
        RssFetchLog::factory()->create([
            'created_at' => now()->subDays(91),
        ]);

        // 89日前のログ（残る）
        RssFetchLog::factory()->create([
            'created_at' => now()->subDays(89),
        ]);

        $this->artisan('logs:cleanup')
            ->expectsOutput('削除完了: 1件')
            ->assertExitCode(0);

        $this->assertDatabaseCount('rss_fetch_logs', 1);
    }

    /** @test */
    public function 削除対象がない場合はメッセージを表示()
    {
        RssFetchLog::factory()->create([
            'created_at' => now()->subDays(30),
        ]);

        $this->artisan('logs:cleanup')
            ->expectsOutput('削除対象のログはありません')
            ->assertExitCode(0);

        $this->assertDatabaseCount('rss_fetch_logs', 1);
    }
}
```

### 10.3 境界値テスト

| created_at | 削除される？ |
|-----------|------------|
| 91日前 | ✅ 削除 |
| 90日前 - 1秒 | ✅ 削除 |
| 90日前（ちょうど） | ❌ 残る |
| 89日前 | ❌ 残る |

**テスト実装のポイント**:
```php
// 90日前ちょうどは残る
now()->subDays(90) // 残る

// 90日前より1秒でも古ければ削除
now()->subDays(90)->subSecond() // 削除される
```

---

## 11. エラーハンドリング

### 11.1 想定されるエラー

| エラー | 原因 | 対応 |
|-------|------|------|
| データベース接続エラー | DB停止、ネットワーク障害 | 例外をキャッチしてログ出力 |
| ロックタイムアウト | 長時間ロック | チャンクサイズを小さくする |
| ディスク容量不足 | ログファイル肥大化 | ログローテーション設定 |

### 11.2 エラーハンドリング実装（オプション）

```php
public function handle(): int
{
    try {
        // 削除処理
        
    } catch (\Exception $e) {
        $this->error('削除処理中にエラーが発生しました');
        $this->error($e->getMessage());
        
        Log::error('記事削除エラー', [
            'message' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
        ]);
        
        return self::FAILURE;
    }
}
```

---

## 12. 運用手順

### 12.1 初回セットアップ

```bash
# 1. 設定ファイルをキャッシュ
php artisan config:cache

# 2. Dry-runで動作確認
php artisan articles:cleanup --dry-run
php artisan logs:cleanup --dry-run

# 3. 手動で1回実行してテスト
php artisan articles:cleanup
php artisan logs:cleanup

# 4. cron設定（サーバー側）
crontab -e
# 以下を追加
* * * * * cd /var/www/newsweek-rss && php artisan schedule:run >> /dev/null 2>&1
```

### 12.2 日常運用

**自動実行（推奨）**:
- スケジューラーが毎日午前3時に自動実行
- ログファイルで結果を確認
```bash
tail -f storage/logs/cleanup.log
```

**手動実行（必要時のみ）**:
```bash
# 緊急時に手動削除
php artisan articles:cleanup

# 削除前に確認
php artisan articles:cleanup --dry-run
```

### 12.3 モニタリング

**定期的に確認する項目**:
```sql
-- 記事の件数推移
SELECT DATE(created_at) as date, COUNT(*) as count 
FROM articles 
GROUP BY DATE(created_at) 
ORDER BY date DESC 
LIMIT 30;

-- 最も古い記事の日付
SELECT MIN(created_at) as oldest FROM articles;

-- 90日を超える記事（本来は存在しないはず）
SELECT COUNT(*) FROM articles WHERE created_at < NOW() - INTERVAL 90 DAY;
```

---

## 13. トラブルシューティング

### 13.1 削除されない場合

**確認項目**:
```bash
# 1. スケジューラーが動いているか
tail -f storage/logs/cleanup.log

# 2. cron設定を確認
crontab -l

# 3. 設定値を確認
php artisan tinker
>>> config('data_lifecycle.articles.retention_days')
```

### 13.2 削除が遅い場合

**対策**:
```php
// config/data_lifecycle.php
'chunk_size' => 500, // 1000 → 500 に縮小
```

### 13.3 ログファイルが肥大化

**ログローテーション設定**:
```bash
# /etc/logrotate.d/newsweek-rss
/var/www/newsweek-rss/storage/logs/*.log {
    daily
    rotate 14
    compress
    missingok
    notifempty
}
```

---

## 14. 将来の拡張案（現時点では不要）

### 14.1 削除件数の上限チェック

```php
if ($targetCount > config('data_lifecycle.articles.max_deletions_per_run')) {
    $this->warn("削除対象が異常に多い: {$targetCount}件");
    $this->warn('処理を中止します。設定を確認してください。');
    return self::FAILURE;
}
```

### 14.2 削除履歴テーブル

```php
Schema::create('data_cleanup_logs', function (Blueprint $table) {
    $table->id();
    $table->string('target_table');
    $table->integer('deleted_count');
    $table->dateTime('cutoff_date');
    $table->timestamps();
});
```

### 14.3 エラー通知（Slack/メール）

```php
// エラー時にSlack通知
if ($deletedCount === 0 && $targetCount > 0) {
    Notification::route('slack', config('services.slack.webhook'))
        ->notify(new CleanupFailedNotification());
}
```

---

## 15. まとめ

### 実装するファイル

| ファイル | 説明 |
|---------|------|
| `config/data_lifecycle.php` | 設定ファイル |
| `app/Console/Commands/CleanupOldArticlesCommand.php` | 記事削除コマンド |
| `app/Console/Commands/CleanupOldLogsCommand.php` | ログ削除コマンド |
| `app/Console/Kernel.php` | スケジューラー設定（既存ファイルに追加） |
| `tests/Feature/Console/Commands/CleanupOldArticlesCommandTest.php` | テスト |
| `tests/Feature/Console/Commands/CleanupOldLogsCommandTest.php` | テスト |

### 主要な設計判断

| 項目 | 採用案 | 理由 |
|------|-------|------|
| 削除基準 | `created_at` | 「保存期間3ヶ月」の自然な解釈 |
| 保存期間 | 90日固定 | シンプル、要件を満たす |
| 削除方式 | 物理削除 | ディスク容量節約、要件に合致 |
| 削除方法 | チャンク削除（1000件） | パフォーマンスとロック時間のバランス |
| 実行タイミング | 毎日午前3時 | サーバー負荷が低い時間帯 |
| 削除順序 | articles → logs | メインデータを優先 |

### 次のステップ

1. ✅ 設計ドキュメント完成
2. ⬜ 設定ファイル作成
3. ⬜ コマンド実装
4. ⬜ スケジューラー設定
5. ⬜ テスト実装
6. ⬜ 動作確認

---

## 参考資料

- `REQUIREMENTS.md` - 課題要件
- `CLAUDE.md` - 実装ルール
- `docs/20251124_1400_今後の実装タスク一覧.md` - タスク一覧
- Laravel公式ドキュメント: [Task Scheduling](https://laravel.com/docs/scheduling)
- Laravel公式ドキュメント: [Artisan Console](https://laravel.com/docs/artisan)

