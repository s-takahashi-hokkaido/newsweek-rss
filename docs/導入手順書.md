# ニューズウィーク日本版 記事検索システム 導入手順書

## 目次

1. [システム概要](#システム概要)
2. [動作環境](#動作環境)
3. [インストール手順](#インストール手順)
4. [データベースセットアップ](#データベースセットアップ)
5. [Webサーバー設定](#webサーバー設定)
6. [定期実行設定](#定期実行設定)
7. [動作確認](#動作確認)

---

## システム概要

本システムは、ニューズウィーク日本版の最新記事をRSSから自動取得し、検索・閲覧できるWebアプリケーションです。

### 主な機能

- RSS自動取得（5分ごと）
- 記事検索（日付・URL・タイトル）
- ページネーション表示
- データライフサイクル管理（3ヶ月自動削除）

---

## 動作環境

本システムは以下の環境で動作します。**以下のソフトウェアがインストール済みであることを前提**としています。

| 項目 | バージョン |
|------|-----------|
| OS | Ubuntu 22.04 LTS |
| Webサーバー | nginx |
| PHP | 8.1.2 以降 |
| データベース | MySQL 8.0.32 以降 |

---

## インストール手順

### 1. システムアップデート

```bash
sudo apt update
sudo apt upgrade -y
```

### 2. PHP拡張モジュールのインストール

Laravelの動作に必要なPHP拡張モジュールをインストールします。

```bash
sudo apt install -y php8.1-cli php8.1-fpm php8.1-mysql php8.1-xml \
    php8.1-mbstring php8.1-curl php8.1-zip php8.1-gd php8.1-bcmath
```

**インストールされるモジュール**:
- `php8.1-cli` - PHPコマンドライン
- `php8.1-fpm` - PHP FastCGI Process Manager
- `php8.1-mysql` - MySQLデータベース接続
- `php8.1-xml` - XML処理
- `php8.1-mbstring` - マルチバイト文字列処理
- `php8.1-curl` - HTTP通信（RSS取得に必要）
- `php8.1-zip` - ZIPファイル処理
- `php8.1-gd` - 画像処理
- `php8.1-bcmath` - 高精度数値計算

### 3. Composerのインストール

PHPの依存パッケージ管理ツールであるComposerをインストールします。

```bash
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
sudo chmod +x /usr/local/bin/composer
composer --version
```

### 4. プロジェクトファイルの配置

```bash
# プロジェクトディレクトリを配置
sudo mkdir -p /var/www
sudo cp -r newsweek-rss /var/www/

# 所有者を設定
sudo chown -R www-data:www-data /var/www/newsweek-rss
```

### 5. パーミッション設定

```bash
cd /var/www/newsweek-rss

# ディレクトリ全体
sudo chmod -R 755 .

# 書き込み可能ディレクトリ
sudo chmod -R 775 storage
sudo chmod -R 775 bootstrap/cache

# 所有者を確認
ls -la storage/ bootstrap/cache/
```

### 6. 依存パッケージのインストール

Composerを使ってLaravelの依存パッケージをインストールします。

```bash
cd /var/www/newsweek-rss

# Composer パッケージをインストール
composer install --optimize-autoloader --no-dev
```

### 7. 環境設定ファイルの作成

```bash
cd /var/www/newsweek-rss

# .env.example から .env を作成
cp .env.example .env

# アプリケーションキーを生成
php artisan key:generate
```

### 8. .env ファイルの編集

```bash
sudo nano .env
```

以下の項目を環境に合わせて設定してください：

```env
# アプリケーション設定
APP_NAME="Newsweek RSS"
APP_ENV=production
APP_DEBUG=false
APP_URL=http://your-domain.com

# データベース設定
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=newsweek_rss
DB_USERNAME=newsweek_user
DB_PASSWORD=your_secure_password_here

# RSS取得設定
RSS_FEED_URL=https://www.newsweekjapan.jp/stories/rss.xml
RSS_USER_AGENT="Mozilla/5.0 (compatible; NewsweekRSSBot/1.0)"
RSS_TIMEOUT=30
RSS_RETRY_TIMES=3
RSS_RETRY_SLEEP=2000

# データライフサイクル設定
ARTICLE_RETENTION_DAYS=90
LOG_RETENTION_DAYS=90
```

**重要**: 本番環境では必ず以下を設定してください：
- `APP_DEBUG=false` （セキュリティのため）
- `DB_PASSWORD` （安全なパスワードを設定）

---

## データベースセットアップ

### 1. データベースとユーザーの作成

MySQLにログインします：

```bash
sudo mysql -u root -p
```

以下のSQL文を実行してください：

```sql
-- データベースを作成
CREATE DATABASE newsweek_rss CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- ユーザーを作成し、パスワードを設定
CREATE USER 'newsweek_user'@'localhost' IDENTIFIED BY 'your_secure_password_here';

-- 権限を付与
GRANT ALL PRIVILEGES ON newsweek_rss.* TO 'newsweek_user'@'localhost';

-- 権限を反映
FLUSH PRIVILEGES;

-- 確認
SHOW DATABASES;
SELECT user, host FROM mysql.user WHERE user = 'newsweek_user';

-- 終了
EXIT;
```

### 2. データベース接続テスト

```bash
mysql -u newsweek_user -p newsweek_rss
# パスワードを入力

# 接続できることを確認
SHOW TABLES;
EXIT;
```

### 3. マイグレーション実行

```bash
cd /var/www/newsweek-rss

# マイグレーションを実行
php artisan migrate --force

# 実行結果を確認
php artisan migrate:status
```

**実行されるマイグレーション**:
- `create_articles_table` - 記事テーブル
- `create_rss_fetch_logs_table` - RSS取得ログテーブル

### 4. テーブル作成の確認

```bash
mysql -u newsweek_user -p newsweek_rss -e "SHOW TABLES;"
mysql -u newsweek_user -p newsweek_rss -e "DESCRIBE articles;"
mysql -u newsweek_user -p newsweek_rss -e "DESCRIBE rss_fetch_logs;"
```

---

## Webサーバー設定

### 1. nginx設定ファイルの作成

```bash
sudo nano /etc/nginx/sites-available/newsweek-rss
```

以下の内容を記述してください：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/newsweek-rss/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    # メインロケーション
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # favicon と robots.txt
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # 404エラーをLaravelに渡す
    error_page 404 /index.php;

    # PHPファイルの処理
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # 隠しファイルへのアクセス拒否
    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

**注意**: `your-domain.com` を実際のドメイン名またはIPアドレスに置き換えてください。

### 2. 設定ファイルの有効化

```bash
# シンボリックリンクを作成
sudo ln -s /etc/nginx/sites-available/newsweek-rss /etc/nginx/sites-enabled/

# デフォルト設定を無効化（必要に応じて）
sudo rm /etc/nginx/sites-enabled/default

# 設定ファイルのテスト
sudo nginx -t
```

### 3. nginx と PHP-FPM の再起動

```bash
# nginx再起動
sudo systemctl restart nginx

# PHP-FPM再起動
sudo systemctl restart php8.1-fpm

# 状態確認
sudo systemctl status nginx
sudo systemctl status php8.1-fpm
```

### 4. PHP-FPM の設定確認

```bash
# PHP-FPMの設定を確認
sudo nano /etc/php/8.1/fpm/pool.d/www.conf

# 以下の設定を確認
# user = www-data
# group = www-data
# listen = /var/run/php/php8.1-fpm.sock
```

---

## 定期実行設定

本システムは以下の定期処理を実行します：

| 処理 | 実行タイミング | 説明 |
|------|--------------|------|
| RSS取得 | 5分ごと | 最新記事を取得 |
| 記事削除 | 毎日午前3時 | 90日以上前の記事を削除 |
| ログ削除 | 毎日午前3時10分 | 90日以上前のログを削除 |

### 1. cronジョブの登録

```bash
# www-dataユーザーのcrontabを編集
sudo crontab -u www-data -e
```

以下の行を追加してください：

```cron
# Laravel Scheduler
* * * * * cd /var/www/newsweek-rss && php artisan schedule:run >> /dev/null 2>&1
```

### 2. cron設定の確認

```bash
# 設定を確認
sudo crontab -u www-data -l

# cronサービスの状態確認
sudo systemctl status cron
```

### 3. スケジュール内容の確認

```bash
cd /var/www/newsweek-rss
php artisan schedule:list
```

以下のような出力が表示されれば正常です：

```
*/5 * * * *  php artisan rss:fetch ........................ Next Due: 4分後
0   3 * * *  php artisan articles:cleanup ................. Next Due: 9時間後
10  3 * * *  php artisan logs:cleanup ..................... Next Due: 9時間後
```

---

## 動作確認

### 1. Webアクセス確認

ブラウザで以下のURLにアクセスしてください：

```
http://your-domain.com
```

記事検索画面が表示されれば成功です。

### 2. 初回RSS取得

```bash
cd /var/www/newsweek-rss

# 手動でRSS取得を実行
php artisan rss:fetch
```

以下のような出力が表示されれば成功です：

```
RSS取得開始
RSS取得完了: 20件の新規記事を保存しました
```

### 3. データベース確認

```bash
# 記事が保存されたことを確認
php artisan tinker --execute="echo 'Total articles: ' . App\Models\Article::count() . PHP_EOL;"

# 最新のRSS取得ログを確認
php artisan tinker --execute="echo App\Models\RssFetchLog::latest()->first();"
```

### 4. 検索機能の動作確認

ブラウザで以下の操作を確認してください：

- [ ] 記事一覧が表示される
- [ ] タイトル検索ができる
- [ ] 日付範囲検索ができる
- [ ] ページネーションが動作する
- [ ] RSS取得状況が表示される

### 5. ログファイルの確認

```bash
# アプリケーションログ
tail -f /var/www/newsweek-rss/storage/logs/laravel.log

# nginx アクセスログ
sudo tail -f /var/log/nginx/access.log

# nginx エラーログ
sudo tail -f /var/log/nginx/error.log
```

---