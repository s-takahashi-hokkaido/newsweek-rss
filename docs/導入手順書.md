# ニューズウィーク日本版 記事検索システム 導入手順書

## 目次

1. [システム概要](#システム概要)
2. [動作環境](#動作環境)
3. [事前準備](#事前準備)
4. [インストール手順](#インストール手順)
5. [初期設定](#初期設定)
6. [データベースセットアップ](#データベースセットアップ)
7. [Webサーバー設定](#webサーバー設定)
8. [定期実行設定](#定期実行設定)
9. [動作確認](#動作確認)
10. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

本システムは、ニューズウィーク日本版の最新記事をRSSから自動取得し、検索・閲覧できるWebアプリケーションです。

### 主な機能

- RSS自動取得（5分ごと）
- 記事検索（日付・URL・タイトル）
- ページネーション表示
- データライフサイクル管理（3ヶ月自動削除）

---

## 動作環境

### 必須要件

| 項目 | バージョン |
|------|-----------|
| OS | Ubuntu 22.04 LTS |
| Webサーバー | nginx |
| PHP | 8.1.2 以降 |
| データベース | MySQL 8.0.32 以降 |

### 必要なPHP拡張モジュール

```
- php8.1-cli
- php8.1-fpm
- php8.1-mysql
- php8.1-xml
- php8.1-mbstring
- php8.1-curl
- php8.1-zip
- php8.1-gd
- php8.1-bcmath
```

---

## 事前準備

### 1. システムアップデート

```bash
sudo apt update
sudo apt upgrade -y
```

### 2. 必要なソフトウェアのインストール

#### PHP 8.1のインストール

```bash
sudo apt install -y php8.1-cli php8.1-fpm php8.1-mysql php8.1-xml \
    php8.1-mbstring php8.1-curl php8.1-zip php8.1-gd php8.1-bcmath
```

#### Composerのインストール

```bash
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
sudo chmod +x /usr/local/bin/composer
composer --version
```

#### nginxのインストール

```bash
sudo apt install -y nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

#### MySQLのインストール

```bash
sudo apt install -y mysql-server
sudo systemctl enable mysql
sudo systemctl start mysql
```

---

## インストール手順

### 1. プロジェクトファイルの配置

```bash
# プロジェクトディレクトリを配置
sudo mkdir -p /var/www
sudo cp -r newsweek-rss /var/www/

# 所有者を設定
sudo chown -R www-data:www-data /var/www/newsweek-rss
```

### 2. パーミッション設定

```bash
cd /var/www/newsweek-rss

# ディレクトリ全体
sudo chmod -R 755 .

# 書き込み可能ディレクトリ
sudo chmod -R 775 storage
sudo chmod -R 775 bootstrap/cache

# 所有者を確認
ls -la storage/ bootstrap/cache/
```

### 3. 依存パッケージのインストール

```bash
cd /var/www/newsweek-rss

# Composer パッケージをインストール
composer install --optimize-autoloader --no-dev

# Node.js パッケージ（必要に応じて）
# npm install
# npm run build
```

---

## 初期設定

### 1. 環境設定ファイルの作成

```bash
cd /var/www/newsweek-rss

# .env.example から .env を作成
cp .env.example .env

# アプリケーションキーを生成
php artisan key:generate
```

### 2. .env ファイルの編集

```bash
sudo nano .env
```

以下の項目を環境に合わせて設定してください：

```env
# アプリケーション設定
APP_NAME="Newsweek RSS"
APP_ENV=production
APP_DEBUG=false
APP_URL=http://your-domain.com

# データベース設定
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=newsweek_rss
DB_USERNAME=newsweek_user
DB_PASSWORD=your_secure_password_here

# RSS取得設定
RSS_FEED_URL=https://www.newsweekjapan.jp/stories/rss.xml
RSS_USER_AGENT="Mozilla/5.0 (compatible; NewsweekRSSBot/1.0)"
RSS_TIMEOUT=30
RSS_RETRY_TIMES=3
RSS_RETRY_SLEEP=2000

# データライフサイクル設定
ARTICLE_RETENTION_DAYS=90
LOG_RETENTION_DAYS=90
```

**重要**: 本番環境では必ず以下を設定してください：
- `APP_DEBUG=false` （セキュリティのため）
- `DB_PASSWORD` （安全なパスワードを設定）

---

## データベースセットアップ

### 1. データベースとユーザーの作成

MySQLにログインします：

```bash
sudo mysql -u root -p
```

以下のSQL文を実行してください：

```sql
-- データベースを作成
CREATE DATABASE newsweek_rss CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- ユーザーを作成し、パスワードを設定
CREATE USER 'newsweek_user'@'localhost' IDENTIFIED BY 'your_secure_password_here';

-- 権限を付与
GRANT ALL PRIVILEGES ON newsweek_rss.* TO 'newsweek_user'@'localhost';

-- 権限を反映
FLUSH PRIVILEGES;

-- 確認
SHOW DATABASES;
SELECT user, host FROM mysql.user WHERE user = 'newsweek_user';

-- 終了
EXIT;
```

### 2. データベース接続テスト

```bash
mysql -u newsweek_user -p newsweek_rss
# パスワードを入力

# 接続できることを確認
SHOW TABLES;
EXIT;
```

### 3. マイグレーション実行

```bash
cd /var/www/newsweek-rss

# マイグレーションを実行
php artisan migrate --force

# 実行結果を確認
php artisan migrate:status
```

**実行されるマイグレーション**:
- `create_articles_table` - 記事テーブル
- `create_rss_fetch_logs_table` - RSS取得ログテーブル

### 4. テーブル作成の確認

```bash
mysql -u newsweek_user -p newsweek_rss -e "SHOW TABLES;"
mysql -u newsweek_user -p newsweek_rss -e "DESCRIBE articles;"
mysql -u newsweek_user -p newsweek_rss -e "DESCRIBE rss_fetch_logs;"
```

---

## Webサーバー設定

### 1. nginx設定ファイルの作成

```bash
sudo nano /etc/nginx/sites-available/newsweek-rss
```

以下の内容を記述してください：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/newsweek-rss/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    # メインロケーション
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # favicon と robots.txt
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # 404エラーをLaravelに渡す
    error_page 404 /index.php;

    # PHPファイルの処理
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # 隠しファイルへのアクセス拒否
    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

**注意**: `your-domain.com` を実際のドメイン名またはIPアドレスに置き換えてください。

### 2. 設定ファイルの有効化

```bash
# シンボリックリンクを作成
sudo ln -s /etc/nginx/sites-available/newsweek-rss /etc/nginx/sites-enabled/

# デフォルト設定を無効化（必要に応じて）
sudo rm /etc/nginx/sites-enabled/default

# 設定ファイルのテスト
sudo nginx -t
```

### 3. nginx と PHP-FPM の再起動

```bash
# nginx再起動
sudo systemctl restart nginx

# PHP-FPM再起動
sudo systemctl restart php8.1-fpm

# 状態確認
sudo systemctl status nginx
sudo systemctl status php8.1-fpm
```

### 4. PHP-FPM の設定確認

```bash
# PHP-FPMの設定を確認
sudo nano /etc/php/8.1/fpm/pool.d/www.conf

# 以下の設定を確認
# user = www-data
# group = www-data
# listen = /var/run/php/php8.1-fpm.sock
```

---

## 定期実行設定

本システムは以下の定期処理を実行します：

| 処理 | 実行タイミング | 説明 |
|------|--------------|------|
| RSS取得 | 5分ごと | 最新記事を取得 |
| 記事削除 | 毎日午前3時 | 90日以上前の記事を削除 |
| ログ削除 | 毎日午前3時10分 | 90日以上前のログを削除 |

### 1. cronジョブの登録

```bash
# www-dataユーザーのcrontabを編集
sudo crontab -u www-data -e
```

以下の行を追加してください：

```cron
# Laravel Scheduler
* * * * * cd /var/www/newsweek-rss && php artisan schedule:run >> /dev/null 2>&1
```

### 2. cron設定の確認

```bash
# 設定を確認
sudo crontab -u www-data -l

# cronサービスの状態確認
sudo systemctl status cron
```

### 3. スケジュール内容の確認

```bash
cd /var/www/newsweek-rss
php artisan schedule:list
```

以下のような出力が表示されれば正常です：

```
*/5 * * * *  php artisan rss:fetch ........................ Next Due: 4分後
0   3 * * *  php artisan articles:cleanup ................. Next Due: 9時間後
10  3 * * *  php artisan logs:cleanup ..................... Next Due: 9時間後
```

---

## 動作確認

### 1. Webアクセス確認

ブラウザで以下のURLにアクセスしてください：

```
http://your-domain.com
```

記事検索画面が表示されれば成功です。

### 2. 初回RSS取得

```bash
cd /var/www/newsweek-rss

# 手動でRSS取得を実行
php artisan rss:fetch
```

以下のような出力が表示されれば成功です：

```
RSS取得開始
RSS取得完了: 20件の新規記事を保存しました
```

### 3. データベース確認

```bash
# 記事が保存されたことを確認
php artisan tinker --execute="echo 'Total articles: ' . App\Models\Article::count() . PHP_EOL;"

# 最新のRSS取得ログを確認
php artisan tinker --execute="echo App\Models\RssFetchLog::latest()->first();"
```

### 4. 検索機能の動作確認

ブラウザで以下の操作を確認してください：

- [ ] 記事一覧が表示される
- [ ] タイトル検索ができる
- [ ] 日付範囲検索ができる
- [ ] ページネーションが動作する
- [ ] RSS取得状況が表示される

### 5. ログファイルの確認

```bash
# アプリケーションログ
tail -f /var/www/newsweek-rss/storage/logs/laravel.log

# nginx アクセスログ
sudo tail -f /var/log/nginx/access.log

# nginx エラーログ
sudo tail -f /var/log/nginx/error.log
```

---

## トラブルシューティング

### 問題1: 500エラーが表示される

**原因**: パーミッション、設定、またはコードエラー

**対処法**:

```bash
# ログを確認
tail -50 /var/www/newsweek-rss/storage/logs/laravel.log

# パーミッションを確認
sudo chmod -R 775 /var/www/newsweek-rss/storage
sudo chmod -R 775 /var/www/newsweek-rss/bootstrap/cache
sudo chown -R www-data:www-data /var/www/newsweek-rss

# 設定キャッシュをクリア
php artisan config:clear
php artisan cache:clear
php artisan view:clear
```

### 問題2: データベース接続エラー

**原因**: データベース設定またはユーザー権限の問題

**対処法**:

```bash
# .env の設定を確認
cat /var/www/newsweek-rss/.env | grep DB_

# MySQL接続テスト
mysql -h 127.0.0.1 -u newsweek_user -p newsweek_rss

# ユーザー権限を確認
sudo mysql -u root -p -e "SHOW GRANTS FOR 'newsweek_user'@'localhost';"
```

### 問題3: RSS取得が失敗する

**原因**: ネットワーク、User-Agent、またはRSS URLの問題

**対処法**:

```bash
# 手動でRSS取得を試行
php artisan rss:fetch

# ログを確認
tail -20 /var/www/newsweek-rss/storage/logs/laravel.log

# User-Agentが設定されているか確認
cat .env | grep RSS_USER_AGENT

# RSS URLに直接アクセステスト
curl -A "Mozilla/5.0" https://www.newsweekjapan.jp/stories/rss.xml
```

### 問題4: スケジューラーが動作しない

**原因**: cron設定またはパーミッションの問題

**対処法**:

```bash
# cron設定を確認
sudo crontab -u www-data -l

# 手動でスケジューラーを実行
cd /var/www/newsweek-rss
php artisan schedule:run

# cronログを確認
sudo tail -f /var/log/syslog | grep CRON
```

### 問題5: nginx 502 Bad Gateway

**原因**: PHP-FPMが起動していない、またはソケットの問題

**対処法**:

```bash
# PHP-FPMの状態確認
sudo systemctl status php8.1-fpm

# ソケットファイルの確認
ls -la /var/run/php/php8.1-fpm.sock

# PHP-FPMのログ確認
sudo tail -f /var/log/php8.1-fpm.log

# PHP-FPM再起動
sudo systemctl restart php8.1-fpm
```

### 問題6: 白い画面が表示される

**原因**: PHPエラー、autoloadの問題

**対処法**:

```bash
# Composerの依存関係を再インストール
cd /var/www/newsweek-rss
composer install --optimize-autoloader

# autoloadを再生成
composer dump-autoload

# 設定をクリア
php artisan config:clear
php artisan cache:clear
```

---

## セキュリティ設定（推奨）

### 1. ファイアウォール設定

```bash
# UFWを有効化
sudo ufw enable

# HTTP/HTTPS を許可
sudo ufw allow 'Nginx Full'

# SSH を許可（リモート接続している場合は必須）
sudo ufw allow OpenSSH

# 状態確認
sudo ufw status
```

### 2. SSL証明書の設定（Let's Encrypt）

```bash
# Certbot をインストール
sudo apt install -y certbot python3-certbot-nginx

# SSL証明書を取得
sudo certbot --nginx -d your-domain.com

# 自動更新のテスト
sudo certbot renew --dry-run
```

### 3. 本番環境の設定確認

```bash
cd /var/www/newsweek-rss

# 以下の設定を確認
grep "APP_DEBUG" .env  # false であること
grep "APP_ENV" .env    # production であること
```

---

## バックアップ（推奨）

### データベースバックアップスクリプト

```bash
#!/bin/bash
# /usr/local/bin/backup-newsweek-db.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/newsweek-rss"
DB_USER="newsweek_user"
DB_PASS="your_secure_password_here"
DB_NAME="newsweek_rss"

# バックアップディレクトリを作成
mkdir -p $BACKUP_DIR

# データベースをバックアップ
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# 圧縮
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 30日以上前のバックアップを削除
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +30 -delete

echo "Backup completed: db_backup_$DATE.sql.gz"
```

### バックアップの自動実行

```bash
# スクリプトに実行権限を付与
sudo chmod +x /usr/local/bin/backup-newsweek-db.sh

# cronに登録（毎日午前2時に実行）
sudo crontab -e

# 以下を追加
0 2 * * * /usr/local/bin/backup-newsweek-db.sh >> /var/log/newsweek-backup.log 2>&1
```

---

## メンテナンスコマンド

### キャッシュクリア

```bash
cd /var/www/newsweek-rss

php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear
```

### 本番環境用の最適化

```bash
cd /var/www/newsweek-rss

php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### ログファイルのクリア

```bash
# 古いログを削除
cd /var/www/newsweek-rss
rm -f storage/logs/*.log

# または最新のログだけ残す
tail -1000 storage/logs/laravel.log > storage/logs/laravel.log.tmp
mv storage/logs/laravel.log.tmp storage/logs/laravel.log
```

### メンテナンスモード

```bash
# メンテナンスモード開始
php artisan down --message="システムメンテナンス中" --retry=60

# メンテナンスモード終了
php artisan up
```

---

## システムアップデート時の手順

アプリケーションを更新する場合は以下の手順を実行してください：

```bash
# 1. メンテナンスモード開始
cd /var/www/newsweek-rss
php artisan down

# 2. 新しいファイルをデプロイ
# （gitやFTPなどで更新）

# 3. 依存パッケージの更新
composer install --optimize-autoloader --no-dev

# 4. マイグレーション実行（データベース変更がある場合）
php artisan migrate --force

# 5. キャッシュクリア
php artisan config:clear
php artisan cache:clear
php artisan view:clear

# 6. 本番環境用の最適化
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 7. パーミッション確認
sudo chown -R www-data:www-data .
sudo chmod -R 775 storage bootstrap/cache

# 8. メンテナンスモード終了
php artisan up

# 9. 動作確認
curl -I http://your-domain.com
```

---

## システム要件チェックリスト

導入完了時に以下の項目を確認してください：

### 環境

- [ ] Ubuntu 22.04 LTS がインストールされている
- [ ] PHP 8.1.2以上がインストールされている
- [ ] 必要なPHP拡張モジュールがインストールされている
- [ ] Composerがインストールされている
- [ ] nginxがインストールされ、起動している
- [ ] MySQLがインストールされ、起動している

### プロジェクト

- [ ] プロジェクトファイルが `/var/www/newsweek-rss` に配置されている
- [ ] パーミッションが正しく設定されている
- [ ] `.env` ファイルが作成され、正しく設定されている
- [ ] `APP_DEBUG=false` が設定されている（本番環境）
- [ ] アプリケーションキーが生成されている

### データベース

- [ ] データベースが作成されている
- [ ] ユーザーが作成され、権限が付与されている
- [ ] マイグレーションが実行されている
- [ ] テーブルが正しく作成されている

### Webサーバー

- [ ] nginx設定ファイルが作成されている
- [ ] 設定ファイルが有効化されている
- [ ] nginx が正常に起動している
- [ ] PHP-FPM が正常に起動している

### 定期実行

- [ ] cronジョブが登録されている
- [ ] スケジュールが正しく設定されている

### 動作確認

- [ ] Webページにアクセスできる
- [ ] RSS取得が成功する
- [ ] 記事が表示される
- [ ] 検索機能が動作する
- [ ] ログが正常に出力される

---

## サポート情報

### ログファイルの場所

| ログ | 場所 |
|------|------|
| Laravelログ | `/var/www/newsweek-rss/storage/logs/laravel.log` |
| nginx アクセスログ | `/var/log/nginx/access.log` |
| nginx エラーログ | `/var/log/nginx/error.log` |
| PHP-FPMログ | `/var/log/php8.1-fpm.log` |

### コマンドリファレンス

| コマンド | 説明 |
|---------|------|
| `php artisan rss:fetch` | RSS取得を手動実行 |
| `php artisan articles:cleanup` | 古い記事を削除 |
| `php artisan articles:cleanup --dry-run` | 削除対象を確認のみ |
| `php artisan schedule:list` | スケジュール一覧を表示 |
| `php artisan schedule:run` | スケジューラーを手動実行 |

---

## 付録: 本番環境チェックリスト

本番環境へのデプロイ前に以下を確認してください：

### セキュリティ

- [ ] `APP_DEBUG=false` が設定されている
- [ ] データベースパスワードが安全なものである
- [ ] ファイアウォールが設定されている
- [ ] SSL証明書がインストールされている（HTTPSを使用する場合）

### パフォーマンス

- [ ] 設定がキャッシュされている（`config:cache`）
- [ ] ルートがキャッシュされている（`route:cache`）
- [ ] ビューがキャッシュされている（`view:cache`）
- [ ] Composerが最適化されている（`--optimize-autoloader`）

### 監視

- [ ] ログローテーションが設定されている
- [ ] バックアップが設定されている
- [ ] cronが正常に動作している
- [ ] エラー通知が設定されている（オプション）

---

**導入完了後は、システムが正常に動作していることを定期的に確認してください。**

---

## 文書情報

- **バージョン**: 1.0
- **最終更新日**: 2025-11-25
- **対象システム**: ニューズウィーク日本版 記事検索システム
- **動作環境**: Ubuntu 22.04 LTS, nginx, PHP 8.1.2+, MySQL 8.0.32+



